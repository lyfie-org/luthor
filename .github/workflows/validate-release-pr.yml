name: Validate Release PR

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - edited
      - synchronize
      - reopened
      - ready_for_review

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read
    steps:
      - name: Validate PR keywords
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('Missing pull request context.');
              return;
            }

            const title = pr.title || '';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let target = '';
            if (/\bboth\b|\[both\]/i.test(title)) {
              target = 'both';
            } else if (/\bheadless\b|\[headless\]/i.test(title)) {
              target = 'headless';
            } else if (/\bluthor\b|\[luthor\]/i.test(title)) {
              target = 'luthor';
            }

            const commits = await github.paginate(github.rest.pulls.listCommits, {
              owner,
              repo,
              pull_number: pr.number,
              per_page: 100,
            });
            const latestCommit = commits.length ? commits[commits.length - 1] : null;
            const latestMessage = latestCommit?.commit?.message || '';

            let bump = '';
            if (/\bmajor\b|\[major\]/i.test(latestMessage)) {
              bump = 'major';
            } else if (/\bminor\b|\[minor\]/i.test(latestMessage)) {
              bump = 'minor';
            } else if (/\bpatch\b|\[patch\]/i.test(latestMessage)) {
              bump = 'patch';
            }

            const missing = [];
            if (!target) {
              missing.push('Add target keyword in PR title: luthor, headless, or both.');
            }
            if (!bump) {
              missing.push('Add version keyword in latest commit message: major, minor, or patch.');
            }

            if (missing.length > 0) {
              const body = [
                'Release validation failed. Please fix the following:',
                ...missing.map((item) => `- ${item}`),
                '',
                'Examples:',
                '- PR title: "feat: add export presets [headless]"',
                '- Latest commit message: "feat: export hooks [minor]"',
              ].join('\n');

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr.number,
                body,
              });

              core.setFailed('Missing required release keywords.');
              return;
            }

            core.info(`Release validation ok. target=${target}, bump=${bump}`);
